## Was sind Normalization discrepancies?

**Normalisierung** = verschiedene Formen einer URL in eine kanonische Form Ã¼berfÃ¼hren (z. B. `%2F` â†’ `/`, `a/../b` â†’ `b`).  
**Normalization discrepancy** liegt vor, wenn **Cache** und **Origin-Server** die URL unterschiedlich normalisieren (decodieren oder Dot-Segmente auflÃ¶sen). Dadurch kann dieselbe Request-URL vom Cache anders interpretiert werden als vom Origin - Grundlage fÃ¼r Web Cache Deception.
#### Was ist das Problem dahinter?
Wenn der Cache eine URL als `/static/...` sieht (also eine statische Resource) und cacht, aber der Origin dieselbe URL nach Normalisierung als `/profile` interpretiert und dynamische Inhalte zurÃ¼ckgibt, landet dynamischer Inhalt unter einem statischen Cache-Key - Leak!

Beispielkonzept:
- Du rufst etwas wie:
    `/static/../../my-account/foo.ico`
    
    - **Cache** sieht den Pfad, sieht `/static/` vorne und denkt: â€das ist statisch â†’ cachebarâ€œ.
    - **Origin** normalisiert den Pfad (`/static/../../my-account/foo.ico` â†’ `/my-account/foo.ico`) und liefert die dynamische Seite.
    - Ergebnis: dynamische Seite landet als `/static/../../my-account/foo.ico` im Cache und kann spÃ¤ter von jedem abgeholt werden.

### ğŸ–¥ï¸ğŸ§ªLab-Part:

- **Origin-Normalisierung getestet:**
    - In Burp Repeater `GET /static/..%2Fmy-account` gesendet.
	    - `..` = *Ein verzeichnis hoch*
	    -  `%2F` = `/` *decoded*
    - Ergebnis: Origin decodiert/normalisiert und lieferte die normale `/my-account`-Seite (Account HTML). â†’ **Origin normalisiert**.
        
- **Cache-Mapping geprÃ¼ft:**
    - In Burp â†’ **HTTP history** geschaut und festgestellt: alle Requests unter `/resources/...` liefern `X-Cache: hit` / `Age` â†’ der Cache speichert Inhalte mit dem `/resources`-Prefix. â†’ **/resources ist in Cache-Regel enthalten**.
        
- **Exploit-URL gebaut:**
    - Payload:
```html
<img style="display:none" src="https://0ae50035035bf632802f1c9d00340013.web-security-academy.net/resources/..%2Fmy-account">
```
    
- Diese URL sieht fÃ¼r den Cache wie eine statische `/resources/...`-Ressource aus, der Origin normalisiert sie aber zu `/my-account`.
        
- **Exploit ausgeliefert & gewartet:**
    - Exploit an Ziel (carlos) geliefert; im Exploit-Server-Log bestÃ¤tigt, dass das Opfer die Seite geladen hat.
        
- **Finaler Abruf (ohne Cookie):**
    - Dieselbe URL (byte-gleich) ohne `Cookie:` im Repeater angefragt.
    - Ergebnis: Cache lieferte die zuvor von carlos erzeugte Account-Seite â†’ API-Key erhalten.


## Exploiting Cache Server normalization

Wenn Cache und Origin Server URL unterschiedlich decoden kann man sich das manchmal zu nutze machen, sodass man beim Cache eine encoded Anfrage schickt die dann durch einen eingefÃ¼gten Delimeter korrekt beim Origin-Server ankommen obwohl er die Anfrage eigentlich ganz falsch interpretieren wÃ¼rde.

Man nutzt Unterschiede aus, wie **Cache-Server** und **Origin-Server** URLs interpretieren.
- Der Cache **normalisiert** Pfade (z. B. `/profile%2f%2e%2e%2fstatic` â†’ `/static`).
- Der Origin-Server tut das **nicht** und sieht die URL anders (z. B. `/profile%2f%2e%2e%2fstatic` â†’ Fehler oder `/profile`).
    

Durch einen **Delimeter-Trick** (z. B. `;`) kann man erreichen, dass:
- **Cache:** `/static` â†’ speichert die Antwort.
- **Origin-Server:** `/profile` â†’ gibt dynamische Daten zurÃ¼ck.

### Lab-Part:

1. Origin-Delimiter getestet (Intruder):**
    - In Burp Repeater `/my-accountabc` â†’ 404.   
    - Anfrage an **Intruder** geschickt mit Payload-Position `/my-accountÂ§Â§abc`.
    - Liste an Delimitern (`?`, `;`, `#`, `%23`, `%3f` â€¦) durchlaufen.       
    - Ergebnis: `?`, `%23`, `%3f`, `#` liefern **200 OK + API-Key** â†’ **Origin interpretiert diese Zeichen als Pfad-Delimiter**.
        
- **Cache-Verhalten geprÃ¼ft:**
    - In Burp Proxy gesehen: Inhalte unter `/resources/...` werden gecached (`X-Cache: hit/miss`).
    - Cache normalisiert `..%2f` Traversals â†’ `/../`.
    - Fazit: Cache-Regel aktiv fÃ¼r `/resources/*`.
        
- **Exploit-URL gebaut:**
    - Payload:
        `/my-account%23%2f%2e%2e%2fresources`
    - **Origin**: durch `%23` wird nur `/my-account` ausgeliefert (API-Key).
    - **Cache**: interpretiert den Rest als `/resources/...` â†’ speichert die Antwort.
        
- **Exploit ausgeliefert & gewartet:**
    - Im Exploit-Server Script eingebaut:
```html
<img style="display:none" src="https://0ae50035035bf632802f1c9d00340013.web-security-academy.net/my-account%23%2f%2e%2e%2fresources?">
```
        
- **Finaler Abruf (ohne Cookie):**
    - Dieselbe URL ohne `Cookie:` erneut abgerufen.
    - Ergebnis: Cache lieferte **Carlosâ€™ Account-Seite inkl. API-Key**.



