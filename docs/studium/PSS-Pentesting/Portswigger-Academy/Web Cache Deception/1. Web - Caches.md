

## Allgemein

- Caches sind Zwischenspeicher die zB beim aufrufen von Webseiten entstehen. Diese Speicher sind gute fÃ¼r statische Inhalte wie Bilder o.Ã¤ um schnellen zugriff auf Homepages zu gewÃ¤hrleisten und nicht jedes Mal alle neu laden.
	- Vorteil: Schnelle Performance auf Webseiten nach dem 1. Mal aufrufen
	- Nachteil: Cache Rules mÃ¼ssen fÃ¼r sensible Inhalte festgelegt werden und auÃŸerdem muss eine solide Struktur gewÃ¤hrleistet werden damit nichts abgefangen werden kann.
- Die Zwischenspeicher hat jeder Server den der Aufruf durchlÃ¤uft also:
	  - **Browser-Cache** â†’ nur lokal beim User.
	  - **Proxy/ISP-Cache** â†’ im Netzwerk oder beim Provider.
	  - **CDN/Reverse Proxy Cache** (z. B. Cloudflare, Akamai, Fastly) â†’ weltweit verteilte Server, nah beim User.

## ðŸ”‘ Was ist ein Cache Key?

- Wenn eine Anfrage beim Cache ankommt, muss der Cache entscheiden:
    - **Hab ich die Antwort schon gespeichert?**
    - Oder **muss ich die Anfrage zum Origin-Server weiterleiten?**
        
- DafÃ¼r bildet der Cache einen eindeutigen â€žSchlÃ¼sselâ€œ (**Cache Key**) aus Teilen der Anfrage.
    - **Standard**: URL-Pfad (`/account`) + Query-Parameter (`?id=123`).
    - oder auch bestimmte **Header** (z. B. `Accept-Language`, `Content-Type`), Cookies oder sogar Hostnamen

## Cache Rules

- Cache-Rules steuern **was** und **wie lange** etwas gecacht werden darf.
- Typisch: Nur statische Inahlte wie (CSS, JS, Bilder) weil diese seltener wechseln

##### Cache Content
- Content der Cache stored werden darf
##### Dynamic Content
- Content der nicht Cache stored werden darf zB: sensible Daten â†’ Kontodaten
- Bekommt Inhalte direkt vom Server
##### Arten von Cache-Rules
- **File-Extension-Regeln**: z. B. `.css`, `.js` â†’ immer cachen.
- **Directory-Regeln**: bestimmte Pfade wie `/static`, `/assets` â†’ Inhalte darin werden gecacht.
- **File-Name-Regeln**: einzelne Dateien wie `robots.txt`, `favicon.ico`.
- Es gibt auch **Custom-Regeln** (z. B. anhand von Parametern oder dynamischer Analyse).
## Web Cache Deception

##### Angriff
- Angreifer baut URL: `../account/home.css`
- Cache: denkt ..`.css` sieht statisch aus -> speicher ich
- Angreifer geht spÃ¤ter auf URL zurÃ¼ck und bekommt die selben angerufenen Daten zurÃ¼ck

##### GegenmaÃŸnahmen
- **Cache Deception Armor**: Ã¼berprÃ¼fen, ob _Dateiendung und tatsÃ¤chlicher Content-Type_ logisch zueinander passen, bevor gecacht wird. 
- **Strikte Trennung statischer und dynamischer Pfade**: Verzeichnisse, die ausschlieÃŸlich statische Assets enthalten, und dynamische Endpunkte klar separieren.
- **Eingegrenzte Cache Keys**: z. B. Query-Parameter, Header oder Cookies aus dem SchlÃ¼ssel aussparen oder aufnehmen, je nach Relevanz fÃ¼r die Antwort. 
- Nutzung von geeigneten HTTP-Headern (`Cache-Control`, `Vary`, `Expires`, `ETag`) zur Validierung und Invalidierung von Cache-EintrÃ¤gen.
- REST-API -> Keine eigene File sondern eine abstrakte File die Logik aufrut. 


### ðŸ–¥ï¸ðŸ§ªLab: Exploiting path mapping for web cache deception

1. Seite mit sensiblen Daten suchen -> /my-account
2. Dort sehen wir API-Key den wir von Carlos brauchen
3. Path-Mapping prÃ¼fen und Zusatz-Segmente hinzufÃ¼gen /my-account/.. ,asd.html, asd.js, asd.css, asd.ico 
	- Kriterium: Normale Seite kommt zurÃ¼ck bzw Server ignoriert ZusÃ¤tze in URL
4. Cache-Verhalten prÃ¼fen -> URL 2x aufrufen
	- `Cache Miss/Hit` 
		- Zweite Antwort deutlich schneller als Erste(schnelles Indiz dafÃ¼r ohne direkt auf Cache-Hit zu achten)
5. .ico war Treffer und ergab **Cache Hit**
6.  Baue Expoit 
	- Body: `<img src="https://0ab100f00494eb0681770cbc006100b9.web-security-academy.net/my-account/foo.ico">`
		- Ruft Seite auf und direkt ohne Click wird expliot geladen weil es als image verpackt wurde.
7. Warte bis Carlos auf Link gedrÃ¼ckt hat und lade spÃ¤ter den selben Link -> Dann sollte sich der Cache laden den Carlos kreiert hat beim Ã¶ffnen. 


## ðŸ—‚ Zusammenfassung Caching & Web Cache Deception

- **Caches gibtâ€™s an verschiedenen Stellen**:
    - **Browser-Cache** â†’ nur lokal beim User.
    - **Proxy/ISP-Cache** â†’ im Netzwerk oder beim Provider.
    - **CDN/Reverse Proxy Cache** (z. B. Cloudflare, Akamai, Fastly) â†’ weltweit verteilte Server, nah beim User.
- **Ablauf normal**:
    - Cache prÃ¼ft: Hab ich die Ressource schon?
        - **Cache Hit** â†’ Liefere gespeicherte Antwort.
        - **Cache Miss** â†’ Hole Antwort vom Origin-Server und speichere sie evtl. ab.
- **Cache Key** â†’ entscheidet, ob zwei Anfragen â€žgleichâ€œ sind (z. B. anhand von Pfad, Parametern, manchmal Headern).
- **Problem (Web Cache Deception)**:
    - Cache interpretiert URL anders als der Origin.
    - Ergebnis: Private, dynamische Antwort landet im Cache (z. B. KontoÃ¼bersicht unter `/account/home.css`).
    - Angreifer kann diese gecachte Antwort spÃ¤ter abrufen.
        
- **SchutzmaÃŸnahmen**:
    - **Sensible Endpunkte** â†’ `Cache-Control: no-store, private`.
    - **Nur statische Ressourcen** whitelisten (`/static/*`, `/images/*`).
    - **CDN/Proxy Regeln** setzen: niemals `/account`, `/profile` etc. cachen.


